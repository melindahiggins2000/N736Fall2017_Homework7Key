---
title: "N736 Homework 7 Answer Key - 2018"
author: "Melinda K. Higgins, PhD."
date: "December 14, 2018"
output: html_document
---

```{r setup, include=FALSE}
# set up knitr options
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

## Repeated Measures ANOVA and Multilevel (mixed) Linear Model (MLM) 

For Homework 7, we're be working with the HELP (`helpmkh`) dataset. Load the data and select the variables:

* `id`
* `treat`
* `mcs`, `mcs1`, `mcs2`, `mcs3`, `mcs4`

```{r}
library(tidyverse)
library(haven)

helpdat <- haven::read_spss("helpmkh.sav")

h1 <- helpdat %>%
  select(id, treat, mcs, mcs1, mcs2, mcs3, mcs4)
```

### Select Complete Cases

To do a repeated measures ANOVA, for which most software packages like SAS and SPSS use listwise deletion, we need to select only the 98 cases with complete data, i.e. no missing or skipped data for the 5 time points of MCS measurements.

```{r}
# compute number of missing values
# across the 5 time points of mcs measurements
h1$nmiss_mcs <- rowSums(is.na(h1[,3:7]))
table(h1$nmiss_mcs)

# keep only the 98 cases with complete data
# where nmiss_mcs equals 0 (none missing)
h198 <- h1 %>%
  filter(nmiss_mcs==0)
```

### Restructure from WIDE into LONG format

Next, put the data into a long format - there should be 98*5 = 490 rows of data.

```{r}
# to do these analyses in R, we first
# have to reshape the data from WIDE
# to long

h198long <- h198 %>%
  gather(key=item,
         value=value,
         -c(id,treat,nmiss_mcs))

# now you have 98*5 = 490 cases
# add a time variable to long format
h198long <- h198long %>%
  mutate(time=c(rep(0,98),
                rep(1,98),
                rep(2,98),
                rep(3,98),
                rep(4,98)))
```

### RM-ANOVA

For an example, see [# see http://psych.wisc.edu/moore/Rpdf/610-R11_MixedDesign.pdf](# see http://psych.wisc.edu/moore/Rpdf/610-R11_MixedDesign.pdf)

We need to convert the subject `id`, `treat` treatment group and `time` within subject into factors.

```{r}
# we can use the aov() function but we
# need to first convert these to factors

h198long$id <- factor(h198long$id) # subject id
h198long$treat <- factor(h198long$treat) # group - between factor
h198long$time <- factor(h198long$time) # time - within factor

# rename the variables
names(h198long) <- c("id","treat","nmiss_mcs",
                   "mcsitem","mcsvalue","time")
```

### Use `aov()` function to perform RM-ANOVA

When we set this up, we need to add the `Error()` term with `id/time` which tells the model that `time` is nested within subject `id`.

```{r}
m1 <- aov(mcsvalue ~ treat*time + Error(id/time), 
          data=h198long) 
summary(m1)
```

### Another approach using `nlme` package and `car::Anova()` Type III SS

```{r}
# MLM Approach
# use nlme package
library(nlme)

lme1 <- nlme::lme(mcsvalue ~ time*treat,
            data=h198long,
            random= ~1 | id,
            method="REML",
            na.action=na.omit)
# get summary - model coefficients
# tests coefficients not equal to 0
summary(lme1)

# get anova tables - both
# of these yield type III Sums of Squares
anova.lme(lme1, type="marginal")
car::Anova(lme1, type="III")
```

### Effects Plots

```{r}
# Graphs - Main effects and interaction graphs
par(mfrow=c(2, 2), cex=0.6, mar=c(4, 4, 4, 2), mex=0.8) 

# sets up for 4 graphs on a page. The next 4 statements ask for main effect means, then the Group x Time interaction effect.
plot(h198long$mcsvalue ~ h198long$treat,
     main="HELP Dataset - Treatment Group Between Subjects Effect", 
     xlab="Treatment Group", ylab="MCS")
plot(h198long$mcsvalue ~ h198long$time,
     main="HELP Dataset - Time Within Subjects Effect", 
     xlab="Time",ylab="MCS")
plot(h198long$mcsvalue ~ h198long$id,
     main="HELP Dataset - CESD by Subjects", 
     xlab="Subjects",ylab="MCS")
interaction.plot(h198long$time,
                 h198long$treat,
                 h198long$mcsvalue,
                 main="HELP Dataset - MCS over Time by Treatment Group", 
                 ylab="MCS")
```

### Another plot option

```{r}
# reset graphics layout
par(mfrow = c(1,1))
# a plot approach
with(h198long, 
     interaction.plot(time, treat, mcsvalue,
                      type="b", col=c("red","blue"), pch=c(16,18),
                      main="Interaction Plot for Treatment Group and Time"))
```

## Multilevel (MIXED) Linear Model (MLM)

For this approach, let's use all available (non-missing) data. So, some subjects may have complete data and others may only have 1 or 2 time points of data.

```{r}
h1 <- helpdat %>%
  select(id, treat, mcs, mcs1, mcs2, mcs3, mcs4)

# use all available data
# restructure into long format

h1long <- h1 %>%
  gather(key=item,
         value=value,
         -c(id,treat),
         na.rm=FALSE)

names(h1long) <- c("id","treat","mcsitem","mcsvalue")

# add a time variable to long format
h1long <- h1long %>%
  mutate(time=c(rep(0,453),
                rep(1,453),
                rep(2,453),
                rep(3,453),
                rep(4,453)))
```

### Error Bar Plots using code from the R-Cookbook

```{r}
# Error Bar Plots
# from the cookbook for R
## Gives count, mean, standard deviation, standard error of the mean, and confidence interval (default 95%).
##   data: a data frame.
##   measurevar: the name of a column that contains the variable to be summariezed
##   groupvars: a vector containing names of columns that contain grouping variables
##   na.rm: a boolean that indicates whether to ignore NA's
##   conf.interval: the percent range of the confidence interval (default is 95%)
summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE) {
  library(plyr)
  
  # New version of length which can handle NA's: if na.rm==T, don't count them
  length2 <- function (x, na.rm=FALSE) {
    if (na.rm) sum(!is.na(x))
    else       length(x)
  }
  
  # This does the summary. For each group's data frame, return a vector with
  # N, mean, and sd
  datac <- ddply(data, groupvars, .drop=.drop,
                 .fun = function(xx, col) {
                   c(N    = length2(xx[[col]], na.rm=na.rm),
                     mean = mean   (xx[[col]], na.rm=na.rm),
                     sd   = sd     (xx[[col]], na.rm=na.rm)
                   )
                 },
                 measurevar
  )
  
  # Rename the "mean" column    
  datac <- rename(datac, c("mean" = measurevar))
  
  datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean
  
  # Confidence interval multiplier for standard error
  # Calculate t-statistic for confidence interval: 
  # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
  ciMult <- qt(conf.interval/2 + .5, datac$N-1)
  datac$ci <- datac$se * ciMult
  
  return(datac)
}

h1long_nomiss <- na.omit(h1long)
#table(h1long_nomiss$time)

h1se <- summarySE(h1long_nomiss, 
                  measurevar="mcsvalue", 
                  groupvars=c("time","treat"))

ggplot(h1se, aes(x=time, y=mcsvalue)) + 
  geom_errorbar(aes(ymin=mcsvalue-se, ymax=mcsvalue+se), 
                width=.1) +
  geom_line() +
  geom_point() +
  xlab("Time Points") +
  ylab("Mental Quality of Life (MCS)") +
  ggtitle("MCS Means and CI's Over Time") +
  facet_wrap(~treat)
```

### MLM models - `nlme` approach and `car::Anova()` Type III SS

```{r}
# MLM Approach
# use nlme package
library(nlme)

lme1 <- nlme::lme(mcsvalue ~ time*treat,
            data=h1long,
            random= ~1 | id,
            method="REML",
            na.action=na.omit)
# get summary - model coefficients
# tests coefficients not equal to 0
summary(lme1)

# get anova tables - both
# of these yield type III Sums of Squares
anova.lme(lme1, type="marginal")
car::Anova(lme1, type="III")
```

### MLM again with `treat` coding flipped

It is always a good idea to flip the coding for a dichotomous variable (`treat`) and double check the interaction term.

```{r}
# you can also use the lme4 package
# read more at https://freshbiostats.wordpress.com/2013/07/28/mixed-models-in-r-lme4-nlme-both/
# and just google nlme vs lme4 package

# flip treat and run again
h1long <- h1long %>%
  mutate(treat_flip = as.numeric(treat==0))

lme2 <- nlme::lme(mcsvalue ~ time*treat_flip,
            data=h1long,
            random= ~1 | id,
            method="REML",
            na.action=na.omit)
# get summary - model coefficients
# tests coefficients not equal to 0
summary(lme2)

# get anova tables - both
# of these yield type III Sums of Squares
anova.lme(lme2, type="marginal")
car::Anova(lme2, type="III")
```

